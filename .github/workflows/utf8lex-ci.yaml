#
# utf8lex
# Copyright Â© 2023-2025 Johann Tienhaara
# All rights reserved
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Utf8lex Continuous Integration

permissions:
  contents: read
  packages: write

#
# Build (on push)
# - Compile utf8lex
# - Link into .so library
# - TODO Link into executable program
# - Upload .so, executable program to GitHub Packages
#
on:
  push: {}
  pull_request:
    types:
      - closed
      # TODO only on merge (requires if logic https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-your-pull_request-workflow-when-a-pull-request-merges)


#
# Platforms supported by qemu GitHub Actions plugin:
#   https://github.com/docker/setup-qemu-action?tab=readme-ov-file#about
# Platforms supported by Docker Debian official image:
#   https://hub.docker.com/_/debian
# Platforms supported by valgrind:
#   https://valgrind.org/info/platforms.html
#
# ? QEMU/GitHub         Docker/Debian       Valgrind
# - ------------------- ------------------- -------------------
# X linux/386           i386                X86/Linux (maintenance)
#   ---                 ---                 X86/Android
#   ---                 ---                 X86/Darwin
#   ---                 ---                 X86/FreeBSD
#   ---                 ---                 X86/illumos
#   ---                 ---                 X86/Solaris
# X linux/amd64         amd64               AMD64/Linux
#   ---                 ---                 AMD64/FreeBSD
#   ---                 ---                 AMD64/illumos
#   ---                 ---                 AMD64/FreeBSD
#   ---                 ---                 AMD64/Solaris
#   ---                 arm32v5
#   linux/arm           ---
# X linux/arm/v7        arm32v7             ARM/Linux
#   ---                 ---                 ARM/Android
# X linux/arm64         arm64v8             ARM64/Linux
#   ---                 ---                 ARM64/Android
#   ---                 ---                 ARM64/FreeBSD
#   ---                 ---                 MIPS32/Linux
#   ---                 ---                 MIPS32/Android
# - linux/mips64        ---                 MIPS64/Linux
# * linux/mips64le      mips64le
# - ---                 ---                 PPC32/Linux
# - ---                 ---                 PPC64/Linux
# X linux/ppc64le       ppc64le             PPC64LE/Linux
# * linux/riscv64       riscv64
# X linux/s390x         s390x               S390X/Linux
#
# X = QEMU, Docker, Valgrind all supported platform.
# * = Disable Valgrind.
#
# Platform name matrix:
#
# QEMU/GitHub         Docker/Debian       Valgrind
# ------------------- ------------------- -------------------
# linux/386           i386                X86/Linux (maintenance)
# linux/amd64         amd64               AMD64/Linux
# linux/arm/v7        arm32v7             ARM/Linux
# linux/arm64         arm64v8             ARM64/Linux
# linux/mips64le      mips64le            UNSUPPORTED
# linux/ppc64le       ppc64le             PPC64LE/Linux
# linux/riscv64       riscv64             UNSUPPORTED
# linux/s390x         s390x               S390X/Linux
#

jobs:
  # ====================================================================
  debian_container_image:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/386
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/mips64le
          - linux/ppc64le
          - linux/riscv64
          - linux/s390x

    env:
      BUILD_DIR: ./build
      DEBIAN_IMAGE_BASE: "utf8lex-debian"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v4

      - id: matrix-platform-env
        name: Set platform/architecture environment variables.
        run: |
          echo "DEBIAN_ARCHITECTURE=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "i386"; }
                     $0 == "linux/amd64" { print "amd64"; }
                     $0 == "linux/arm/v7" { print "arm32v7"; }
                     $0 == "linux/arm64" { print "arm64v8"; }
                     $0 == "linux/mips64le" { print "mips64le"; }
                     $0 == "linux/ppc64le" { print "ppc64le"; }
                     $0 == "linux/riscv64" { print "riscv64"; }
                     $0 == "linux/s390x" { print "s390x"; }
                    ' \
              > $GITHUB_ENV
          echo "VALGRIND_PLATFORM=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "X86/Linux"; }
                     $0 == "linux/amd64" { print "AMD64/Linux"; }
                     $0 == "linux/arm/v7" { print "ARM/Linux"; }
                     $0 == "linux/arm64" { print "ARM64/Linux"; }
                     $0 == "linux/mips64le" { print "UNSUPPORTED"; }
                     $0 == "linux/ppc64le" { print "PPC64LE/Linux"; }
                     $0 == "linux/riscv64" { print "UNSUPPORTED"; }
                     $0 == "linux/s390x" { print "S390X/Linux"; }
                    ' \
              > $GITHUB_ENV

      #
      # https://docs.docker.com/build/ci/github-actions/cache/
      #
      - id: container-image-cache-restore
        name: Restore container image
        #
        # Never use actions/cache/restore:
        #
        #     https://github.com/orgs/community/discussions/27059#discussioncomment-10084333
        #
        uses: actions/cache@v4
        with:
          path: /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          key: utf8lex-debian-container-image-cache-${{ hashFiles('debian.Dockerfile') }}

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action
      - id: qemu-setup
        name: qemu for multi-platform docker support
        if: steps.container-image-cache-restore.outputs.cache-hit != 'true'
        uses: docker/setup-qemu-action@v3

      - id: docker-buildx-setup
        name: Set up Docker Buildx
        if: steps.container-image-cache-restore.outputs.cache-hit != 'true'
        uses: docker/setup-buildx-action@v3

      #
      # Documentation:
      #     https://docs.docker.com/reference/cli/docker/buildx/build/
      #
      # Docker does not support loading multi-platform images from files (!):
      #     https://stackoverflow.com/questions/72945407/how-do-i-import-and-run-a-multi-platform-oci-image-in-docker-for-macos/73058421#73058421
      #
      # So we have to use the matrix to build multiple platforms,
      # and even then, we can't seem to docker image load any format
      # created by docker buildx build, so we have to do docker image save.
      #
      - id: build-container-image
        name: Build utf8lex container for building and testing
        if: steps.container-image-cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          docker buildx build \
              --file debian.Dockerfile \
              --load \
              --platform ${{env.DEBIAN_ARCHITECTURE}} \
              --build-arg ${{env.VALGRIND_PLATFORM}} \
              --tag ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }} \
              .
          docker image save \
              --output ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar \
              ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }}

      - id: gzip-debian-container-image
        name: Gzip utf8lex Debian container image
        if: steps.container-image-cache-restore.outputs.cache-hit != 'true'
        run: |
          gzip ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar

      #
      # Do not use actions/cache/save, it doesn't work.
      # Using actions/cache up above adds automagic.
      # We just copy the Debian container image to where the
      # cache automagic expects to find it, in /tmp.
      #
      - id: container-image-cache-save
        name: Cache the built container image
        if: steps.container-image-cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p /tmp/builder/
          rm -rf /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          cp ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz \
              /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz

      #
      # https://github.com/actions/upload-artifact
      #
      - id: upload-container-image
        name: Upload the container image
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          path: /tmp/builder/
          if-no-files-found: error
          retention-days: 1
  # --------------------------------------------------------------------

  # ====================================================================
  build:
    needs:
      - debian_container_image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/386
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/mips64le
          - linux/ppc64le
          - linux/riscv64
          - linux/s390x
    env:
      BUILD_DIR: ./build
      DEBIAN_IMAGE_BASE: "utf8lex-debian"
      UTF8LEX_VERSION: "${{github.ref_name}}"
      SHARED_LIBRARY_BASE: "libutf8lex.so"
      PROGRAM_BASE: "utf8lex"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v4

      - id: matrix-platform-env
        name: Set platform/architecture environment variables.
        run: |
          echo "DEBIAN_ARCHITECTURE=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "i386"; }
                     $0 == "linux/amd64" { print "amd64"; }
                     $0 == "linux/arm/v7" { print "arm32v7"; }
                     $0 == "linux/arm64" { print "arm64v8"; }
                     $0 == "linux/mips64le" { print "mips64le"; }
                     $0 == "linux/ppc64le" { print "ppc64le"; }
                     $0 == "linux/riscv64" { print "riscv64"; }
                     $0 == "linux/s390x" { print "s390x"; }
                    ' \
              > $GITHUB_ENV

      - id: utf8lex-version-env
        name: Set the full utf8lex library and program names, with version
        run: |
            echo "SHARED_LIBRARY=${{env.SHARED_LIBRARY_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV
            echo "PROGRAM=${{env.PROGRAM_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV

      - id: download-container-image
        name: Download container image
        uses: actions/download-artifact@v4
        with:
          name: ${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          path: /tmp/builder/

      - id: copy-container-image
        name: Copy container image to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz \
              ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          gunzip ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action
      - id: qemu-setup
        name: qemu for multi-platform docker run support
        uses: docker/setup-qemu-action@v3

      - id: build-utf8lex
        name: Build utf8lex (libraries, executables, ...)
        run: |
          sudo systemctl start docker
          docker image load \
              --input ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          rm ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          chmod -R a+w ${{env.BUILD_DIR}}
          #
          # docker run documentation:
          #     https://docs.docker.com/reference/cli/docker/container/run/
          #
          docker run \
                  --rm \
                  --platform ${{env.DEBIAN_ARCHITECTURE}} \
                  --volume `pwd`:/utf8lex:rw \
                  ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }} \
                  make build \
                      BUILD_DIR=../${{env.BUILD_DIR}} \
                      UTF8LEX_VERSION=${{env.UTF8LEX_VERSION}}

      - id: prepare-utf8lex-for-upload
        name: Prepare utf8lex (libraries, executables, ...) for artifact upload
        run: |
          mkdir -p /tmp/utf8lex/
          cp ${{env.BUILD_DIR}}/${{env.SHARED_LIBRARY}} \
              /tmp/utf8lex/${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}}
          cp ${{env.BUILD_DIR}}/${{env.PROGRAM}} \
              /tmp/utf8lex/${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}}

      - id: upload-utf8lex-library
        name: Upload utf8lex library
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/
          if-no-files-found: error
          retention-days: 1

      - id: upload-utf8lex-program
        name: Upload utf8lex program
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/
          if-no-files-found: error
          retention-days: 1
  # --------------------------------------------------------------------


  # ====================================================================
  unit_tests:
    needs:
      - debian_container_image
      - build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/386
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/mips64le
          - linux/ppc64le
          - linux/riscv64
          - linux/s390x

    env:
      BUILD_DIR: ./build
      TEST_BUILD_DIR: ./tests/build
      DEBIAN_IMAGE_BASE: "utf8lex-debian"
      UTF8LEX_VERSION: "${{github.ref_name}}"
      SHARED_LIBRARY_BASE: "libutf8lex.so"
      PROGRAM_BASE: "utf8lex"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v4

      - id: matrix-platform-env
        name: Set platform/architecture environment variables.
        run: |
          echo "DEBIAN_ARCHITECTURE=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "i386"; }
                     $0 == "linux/amd64" { print "amd64"; }
                     $0 == "linux/arm/v7" { print "arm32v7"; }
                     $0 == "linux/arm64" { print "arm64v8"; }
                     $0 == "linux/mips64le" { print "mips64le"; }
                     $0 == "linux/ppc64le" { print "ppc64le"; }
                     $0 == "linux/riscv64" { print "riscv64"; }
                     $0 == "linux/s390x" { print "s390x"; }
                    ' \
              > $GITHUB_ENV

      - id: download-container-image
        name: Download container image
        uses: actions/download-artifact@v4
        with:
          name: ${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          path: /tmp/builder/

      - id: copy-container-image
        name: Copy container image to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz \
              ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          gunzip ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz

      - id: utf8lex-version-env
        name: Set the full utf8lex library and program names, with version
        run: |
            echo "SHARED_LIBRARY=${{env.SHARED_LIBRARY_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV
            echo "PROGRAM=${{env.PROGRAM_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV

      - id: download-utf8lex-library
        name: Download utf8lex library
        uses: actions/download-artifact@v4
        with:
          name: ${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: download-utf8lex-program
        name: Download utf8lex program
        uses: actions/download-artifact@v4
        with:
          name: ${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: copy-utf8lex
        name: Copy utf8lex binaries to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/utf8lex/${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.SHARED_LIBRARY}}
          cp /tmp/utf8lex/${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.PROGRAM}}

      - id: sym-link-utf8lex
        name: Symbolically link libutf8lex.so, .so.1, utf8lex, etc
        run: |
          #
          # We have e.g. library libutf8lex.so.1.2.3 and program utf8lex1.2.3.
          # Now we sym link libraries libutf8lex.so and libutf8lex.so.1
          # and programs utf8lex and utf8lex.1.
          #
          cd ${{env.BUILD_DIR}}
          ln -s ${{env.SHARED_LIBRARY}} \
              ${{env.SHARED_LIBRARY_BASE}}
          ln -s ${{env.PROGRAM}} \
              ${{env.PROGRAM_BASE}}
          MAJOR=`echo "${{env.UTF8LEX_VERSION}}" | sed 's|^\([^\.]*\)\..*$|\1|'`
          if test "$MAJOR" != "${{env.UTF8LEX_VERSION}}"; \
          then \
              ln -s ${{env.SHARED_LIBRARY}} \
                  ${{env.SHARED_LIBRARY_BASE}}.$MAJOR ; \
              ln -s ${{env.PROGRAM}} \
                  ${{env.PROGRAM_BASE}}.$MAJOR ; \
          fi

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action
      - id: qemu-setup
        name: qemu for multi-platform docker run support
        uses: docker/setup-qemu-action@v3

      - id: run-tests
        name: Run tests
        run: |
          sudo systemctl start docker
          docker image load \
              --input ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          rm ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          chmod -R a+w ${{env.BUILD_DIR}}
          chmod a+x ${{env.BUILD_DIR}}/${{env.PROGRAM}}
          mkdir -p ${{env.TEST_BUILD_DIR}}/
          chmod -R a+w ${{env.TEST_BUILD_DIR}}
          #
          # docker run documentation:
          #     https://docs.docker.com/reference/cli/docker/container/run/
          #
          docker run \
                  --rm \
                  --platform ${{env.DEBIAN_ARCHITECTURE}} \
                  --volume `pwd`:/utf8lex:rw \
                  ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }} \
                  make unit_tests \
                      BUILD_DIR=../../${{env.BUILD_DIR}} \
                      UTF8LEX_VERSION=${{env.UTF8LEX_VERSION}} \
                      TEST_BUILD_DIR=../../${{env.TEST_BUILD_DIR}}
  # --------------------------------------------------------------------


  # ====================================================================
  integration_tests:
    needs:
      - debian_container_image
      - build
      - unit_tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/386
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/mips64le
          - linux/ppc64le
          - linux/riscv64
          - linux/s390x

    env:
      BUILD_DIR: ./build
      TEST_BUILD_DIR: ./tests/build
      DEBIAN_IMAGE_BASE: "utf8lex-debian"
      UTF8LEX_VERSION: "${{github.ref_name}}"
      SHARED_LIBRARY_BASE: "libutf8lex.so"
      PROGRAM_BASE: "utf8lex"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v4

      - id: matrix-platform-env
        name: Set platform/architecture environment variables.
        run: |
          echo "DEBIAN_ARCHITECTURE=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "i386"; }
                     $0 == "linux/amd64" { print "amd64"; }
                     $0 == "linux/arm/v7" { print "arm32v7"; }
                     $0 == "linux/arm64" { print "arm64v8"; }
                     $0 == "linux/mips64le" { print "mips64le"; }
                     $0 == "linux/ppc64le" { print "ppc64le"; }
                     $0 == "linux/riscv64" { print "riscv64"; }
                     $0 == "linux/s390x" { print "s390x"; }
                    ' \
              > $GITHUB_ENV

      - id: download-container-image
        name: Download container image
        uses: actions/download-artifact@v4
        with:
          name: ${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          path: /tmp/builder/

      - id: copy-container-image
        name: Copy container image to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz \
              ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          gunzip ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz

      - id: utf8lex-version-env
        name: Set the full utf8lex library and program names, with version
        run: |
            echo "SHARED_LIBRARY=${{env.SHARED_LIBRARY_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV
            echo "PROGRAM=${{env.PROGRAM_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV

      - id: download-utf8lex-library
        name: Download utf8lex library
        uses: actions/download-artifact@v4
        with:
          name: ${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: download-utf8lex-program
        name: Download utf8lex program
        uses: actions/download-artifact@v4
        with:
          name: ${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: copy-utf8lex
        name: Copy utf8lex binaries to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/utf8lex/${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.SHARED_LIBRARY}}
          cp /tmp/utf8lex/${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.PROGRAM}}

      - id: sym-link-utf8lex
        name: Symbolically link libutf8lex.so, .so.1, utf8lex, etc
        run: |
          #
          # We have e.g. library libutf8lex.so.1.2.3 and program utf8lex1.2.3.
          # Now we sym link libraries libutf8lex.so and libutf8lex.so.1
          # and programs utf8lex and utf8lex.1.
          #
          cd ${{env.BUILD_DIR}}
          ln -s ${{env.SHARED_LIBRARY}} \
              ${{env.SHARED_LIBRARY_BASE}}
          ln -s ${{env.PROGRAM}} \
              ${{env.PROGRAM_BASE}}
          MAJOR=`echo "${{env.UTF8LEX_VERSION}}" | sed 's|^\([^\.]*\)\..*$|\1|'`
          if test "$MAJOR" != "${{env.UTF8LEX_VERSION}}"; \
          then \
              ln -s ${{env.SHARED_LIBRARY}} \
                  ${{env.SHARED_LIBRARY_BASE}}.$MAJOR ; \
              ln -s ${{env.PROGRAM}} \
                  ${{env.PROGRAM_BASE}}.$MAJOR ; \
          fi

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action
      - id: qemu-setup
        name: qemu for multi-platform docker run support
        uses: docker/setup-qemu-action@v3

      - id: run-tests
        name: Run tests
        run: |
          sudo systemctl start docker
          docker image load \
              --input ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          rm ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          chmod -R a+w ${{env.BUILD_DIR}}
          chmod a+x ${{env.BUILD_DIR}}/${{env.PROGRAM}}
          mkdir -p ${{env.TEST_BUILD_DIR}}/
          chmod -R a+w ${{env.TEST_BUILD_DIR}}
          #
          # docker run documentation:
          #     https://docs.docker.com/reference/cli/docker/container/run/
          #
          docker run \
                  --rm \
                  --platform ${{env.DEBIAN_ARCHITECTURE}} \
                  --volume `pwd`:/utf8lex:rw \
                  ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }} \
                  make integration_tests \
                      BUILD_DIR=../../${{env.BUILD_DIR}} \
                      UTF8LEX_VERSION=${{env.UTF8LEX_VERSION}} \
                      TEST_BUILD_DIR=../../${{env.TEST_BUILD_DIR}}
  # --------------------------------------------------------------------


  # ====================================================================
  examples:
    needs:
      - debian_container_image
      - build
      - unit_tests
      - integration_tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - linux/386
          - linux/amd64
          - linux/arm/v7
          - linux/arm64
          - linux/mips64le
          - linux/ppc64le
          - linux/riscv64
          - linux/s390x

    env:
      BUILD_DIR: ./build
      EXAMPLES_DIR: ./examples
      EXAMPLES_BUILD_DIR: ./examples/build
      DEBIAN_IMAGE_BASE: "utf8lex-debian"
      UTF8LEX_VERSION: "${{github.ref_name}}"
      SHARED_LIBRARY_BASE: "libutf8lex.so"
      PROGRAM_BASE: "utf8lex"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v4

      - id: matrix-platform-env
        name: Set platform/architecture environment variables.
        run: |
          echo "DEBIAN_ARCHITECTURE=${{matrix.platform}}" \
              | awk '
                     $0 == "linux/386" { print "i386"; }
                     $0 == "linux/amd64" { print "amd64"; }
                     $0 == "linux/arm/v7" { print "arm32v7"; }
                     $0 == "linux/arm64" { print "arm64v8"; }
                     $0 == "linux/mips64le" { print "mips64le"; }
                     $0 == "linux/ppc64le" { print "ppc64le"; }
                     $0 == "linux/riscv64" { print "riscv64"; }
                     $0 == "linux/s390x" { print "s390x"; }
                    ' \
              > $GITHUB_ENV

      - id: download-container-image
        name: Download container image
        uses: actions/download-artifact@v4
        with:
          name: ${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          path: /tmp/builder/

      - id: copy-container-image
        name: Copy container image to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/builder/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz \
              ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz
          gunzip ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar.gz

      - id: utf8lex-version-env
        name: Set the full utf8lex library and program names, with version
        run: |
            echo "SHARED_LIBRARY=${{env.SHARED_LIBRARY_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV
            echo "PROGRAM=${{env.PROGRAM_BASE}}.${{env.UTF8LEX_VERSION}}" \
                >> $GITHUB_ENV

      - id: download-utf8lex-library
        name: Download utf8lex library
        uses: actions/download-artifact@v4
        with:
          name: ${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: download-utf8lex-program
        name: Download utf8lex program
        uses: actions/download-artifact@v4
        with:
          name: ${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}}
          path: /tmp/utf8lex/

      - id: copy-utf8lex
        name: Copy utf8lex binaries to build directory
        run: |
          mkdir -p ${{env.BUILD_DIR}}/
          cp /tmp/utf8lex/${{env.SHARED_LIBRARY}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.SHARED_LIBRARY}}
          cp /tmp/utf8lex/${{env.PROGRAM}}.${{env.DEBIAN_ARCHITECTURE}} \
              ${{env.BUILD_DIR}}/${{env.PROGRAM}}

      - id: sym-link-utf8lex
        name: Symbolically link libutf8lex.so, .so.1, utf8lex, etc
        run: |
          #
          # We have e.g. library libutf8lex.so.1.2.3 and program utf8lex1.2.3.
          # Now we sym link libraries libutf8lex.so and libutf8lex.so.1
          # and programs utf8lex and utf8lex.1.
          #
          cd ${{env.BUILD_DIR}}
          ln -s ${{env.SHARED_LIBRARY}} \
              ${{env.SHARED_LIBRARY_BASE}}
          ln -s ${{env.PROGRAM}} \
              ${{env.PROGRAM_BASE}}
          MAJOR=`echo "${{env.UTF8LEX_VERSION}}" | sed 's|^\([^\.]*\)\..*$|\1|'`
          if test "$MAJOR" != "${{env.UTF8LEX_VERSION}}"; \
          then \
              ln -s ${{env.SHARED_LIBRARY}} \
                  ${{env.SHARED_LIBRARY_BASE}}.$MAJOR ; \
              ln -s ${{env.PROGRAM}} \
                  ${{env.PROGRAM_BASE}}.$MAJOR ; \
          fi

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action
      - id: qemu-setup
        name: qemu for multi-platform docker run support
        uses: docker/setup-qemu-action@v3

      - id: run-examples
        name: Run examples
        run: |
          sudo systemctl start docker
          docker image load \
              --input ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          rm ${{env.BUILD_DIR}}/${{env.DEBIAN_IMAGE_BASE}}.${{env.DEBIAN_ARCHITECTURE}}.${{ hashFiles('debian.Dockerfile') }}.tar
          chmod -R a+w ${{env.BUILD_DIR}}
          chmod a+x ${{env.BUILD_DIR}}/${{env.PROGRAM}}
          mkdir -p ${{env.EXAMPLES_BUILD_DIR}}/
          chmod -R a+w ${{env.EXAMPLES_DIR}}
          chmod -R a+w ${{env.EXAMPLES_BUILD_DIR}}
          #
          # docker run documentation:
          #     https://docs.docker.com/reference/cli/docker/container/run/
          #
          docker run \
                  --rm \
                  --platform ${{env.DEBIAN_ARCHITECTURE}} \
                  --volume `pwd`:/utf8lex:rw \
                  ${{env.DEBIAN_IMAGE_BASE}}:${{ hashFiles('debian.Dockerfile') }} \
                  make examples \
                      BUILD_DIR=../${{env.BUILD_DIR}} \
                      UTF8LEX_VERSION=${{env.UTF8LEX_VERSION}} \
                      EXAMPLES_BUILD_DIR=../${{env.EXAMPLES_BUILD_DIR}}
  # --------------------------------------------------------------------

#
# Release (on push tag)
# - Upload .so library, program to GitHub packages
# - Create a GitHub Release
#
# TODO
